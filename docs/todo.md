# Test Coverage Plan (post `python -m pytest --cov`)

- [x] Overall coverage now sits at ~76% from `python -m pytest --cov`. Remaining low spots are `trader_bot/dashboard.py`, `trader_bot/gemini_trader.py`, `trader_bot/strategy_runner.py`, `trader_bot/trader.py`, `trader_bot/services/trade_action_handler.py`, and `trader_bot/services/plan_monitor.py`. Coverage run still emits coverage-parser `ResourceWarning` noise, but test DBs are closing cleanly and the dashboard unit tests are now lean.

## High-Priority Coverage Additions
- [x] `trader_bot/strategy_runner.py` (56%): focus on `_reconcile_exchange_state`, `_reconcile_open_orders`, and `_monitor_trade_plans` happy/error paths without touching the full loop; cover shutdown paths (`_set_shutdown_reason`, signal handler), rebuild logic (`_rebuild_session_stats_from_trades`, `_capture_ohlcv` failure handling), and slippage/liquidity/stacking edge cases not exercised in overlays (e.g., SELL path, zero/latest price guards).
- [x] `trader_bot/services/trade_action_handler.py` (76%): cover partial-close and update-plan branches when plans are missing/zero size, telemetry/error reporting paths, and `stacking_block` filtering; add tests for `compute_slippage_cap` interactions with thin books/spread caps and `liquidity_ok` logging on bad depth.
- [x] `trader_bot/strategy.py` (79%): unit test `_extract_json_payload` edge cases (multiple braces, malformed fences), `_is_choppy` regime filter, and the budget/lockout logic around `_llm_ready`, `_consecutive_llm_errors`, and `LLM_MIN_CALL_INTERVAL_SECONDS`; add tool-coordinator flow tests for `generate_signal` covering UPDATE_PLAN/PARTIAL_CLOSE/CLOSE_POSITION decisions, break-glass cooldown, and schema validation failures; exercise OpenAI vs Gemini provider selection with/without keys.
- [x] `trader_bot/gemini_trader.py` (47%): add connection tests for sandbox URL override and duplicate connect guard; cover `get_market_data_async` when order book fetch fails and when symbol is malformed; add `_calculate_total_usd` tests for inverted pairs/missing markets; cover `get_positions_async` with cash + non-cash symbols; test `get_equity_async` error path; add cancel/get_open_orders branches and `place_order_async` failure when ticker lacks bid/ask plus liquidity detection from `info.fillLiquidity`.
- [x] `trader_bot/database.py` (79%): target untested helpers—`log_estimated_fee`, `log_llm_trace`/`update_llm_trace_execution`/`prune_llm_traces`, `log_market_data` + `prune_market_data`, `log_ohlcv_batch` timestamp normalization, `prune_ohlcv`, `get_recent_llm_stats` counters, `set_session_stats_cache`/`get_session_stats_cache`, risk_state getters/setters, command lifecycle (`create_command`, `mark_command_executed`, `clear_old_commands`, `prune_commands`), trade plan helpers (`get_trade_plan_reason_by_order`, `count_open_trade_plans_for_symbol`), and `get_session_stats` fallback rebuild of gross/net PnL; ensure tests close connections to avoid ResourceWarnings.
- [x] `trader_bot/data_fetch_coordinator.py` (84%): cover cache pruning and rate-limit resets, `_check_rate_limit` denial path, `_get_cached_response` hit/miss with staleness, symbol allowlist rejection, and fallback builds for order book/trades when providers raise; add `_build_candles_from_trades` aggregation edge cases (out-of-order trades, zero volume).
- [x] `trader_bot/services/resync_service.py` (79%): add tests for `refresh_bindings` failure handling, `rebuild_positions_from_exchange` when exchange returns empty/raises, and `resync_processed_trades` pagination/duplicate suppression; cover logging around mismatched session IDs and when `mark_trade_processed` raises.
- [x] `trader_bot/services/plan_monitor.py` (81%): test stop/target trail adjustments across BUY/SELL, breakeven promotion, stale price skips, and branch where open_orders contain no matching IDs; cover exception handling when DB lookups fail.
- [x] `trader_bot/dashboard.py` (39%): isolate helper functions for testing (timezone resolution, `is_bot_running`/`start_bot` happy/error paths, `load_history`/`get_latest_prices` empty/error handling, `get_timezone_label`); add PnL calculation scenarios with partial fills/unrealized exposure and multiple symbols; validate ratio badge thresholds and trade-spacing metrics; consider factoring UI wiring into smaller functions to allow streamlit-less testing.
- [x] `trader_bot/trader.py` (70%): add a simple ABC enforcement test ensuring abstract methods require implementation and subclasses satisfy the interface (boosts small gap quickly).
- [x] `trader_bot/config.py` (98%) and `trader_bot/logger_config.py` (90%): add edge-case tests for maker overrides parsing, correlation bucket parsing with malformed input, and logger setup when env vars are absent/present.

## Existing Test Improvements / Deletions
- [x] Fix the ResourceWarnings by ensuring every `TradingDatabase` instantiation in tests uses the `test_db_path` fixture and `close()` in teardown (e.g., `tests/unit/trader_bot/test_utils_and_trader.py`, any others using the default path).
- [x] Speed up `tests/unit/trader_bot/test_dashboard.py` (~10s total) by reusing a single imported module fixture or extracting pure helpers so tests avoid repeated module import/monkeypatch overhead.
- [x] Consolidated `StrategyRunner` unit coverage into `tests/unit/trader_bot/test_strategy_runner.py` (moved overlays, circuit breaker, action handling, plan monitor, symbol selection, OHLCV capture, runner pacing, and risk exposure tests into one module).
- [x] Audit integration coverage overlap: `tests/integration/test_strategy_runner_control_paths.py` + service-level tests already cover many control branches—consider consolidating redundant scenarios into parametrized unit tests and trimming any duplicate integration cases once new unit coverage exists (no deletions yet, just a consolidation checkpoint).
- [x] Standardize fake exchange/bot fixtures across Gemini/runner tests to reduce bespoke stubs and make failure-path coverage easier to add; this should also simplify future deletions of one-off stubs once the shared fixtures exist.
- [x] Keep `pytest --durations` in CI to flag regressions; dashboard tests now use lean helper-level coverage and there are no remaining heavy import tests to delete.
