# Review – 2025-11-24

**Findings**
- Session stats still fragile: cache rebuild now runs, but stats depend on synced trades; if exchange sync lags or symbols diverge, fee/gross PnL can drift. No single “authoritative” stats table; we recompute from trades but don’t reconcile against `sessions` totals or true equity deltas.
- Trade plan lifecycle is partial: plans only close on stop/target hit using the last tick; they’re not tied to fills, so partial fills or manual closes leave plans open. No max-age/day-end flatten, no per-symbol open-plan cap, and plans aren’t canceled when exposure headroom is low.
- Exposure controls: we sum pending BUY orders, but we don’t enforce per-symbol open-order limits or adjust for partially filled orders; maker/taker retries can double-submit. OPEN_ORDER_COUNT uses `MAX_POSITIONS` as a display, but there’s no server-side enforcement.
- Prompt/LLM safety: schema validation added, but we still trust model-provided stops/targets (no floor/ceil). We don’t feed back recent auto-stop events or win/loss streaks, and we don’t log/visualize validation/clamping outcomes. No retry/fallback if JSON validation fails.
- Risk handling: no end-of-day or max-holding-time flatten; kill switch only on daily loss. No slippage guard between decision price and fill price; no price check before reusing cached stop/target.
- Testing gaps: no integration test for cache rebuild vs trades, no coverage for trade plan monitor (stop/target hits) or open-order exposure accounting with partial fills.

## Tasks
- [x] Make session stats authoritative: rebuild from trades, update cache and `sessions`, sanity-check vs equity deltas.
- [x] Harden trade plans: tie status to fills/flat, add max age/day-end flatten, per-symbol plan cap, cancel when headroom low.
- [ ] Enforce per-symbol open-order limits and pending-exposure caps before sending orders; handle partial fills.
- [ ] Clamp LLM outputs: bound stops/targets, reject extremes/missing stops, log clamping/validation to dashboard.
- [ ] Add EOD/holding-time risk and slippage guard between decision price and current price.
- [ ] Expand tests: cache rebuild vs trade count; stop/target monitor; open-order exposure with partial fills; prompt validation failure path.
